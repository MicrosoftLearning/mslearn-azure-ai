# Copilot Instructions for mslearn-azure-ai

## General Rules

### Starter Folder

Never browse, read, or reference files in the `starter/` folder unless the user explicitly asks you to. The starter folder contains incomplete versions of exercises and should not be used as a reference for patterns, code, or structure.

### Deleted Files

If a file you previously worked on during the current session has been deleted, ask the user before re-creating it. Do not automatically recreate deleted files.

### Environment Variable Files

Never create or edit *.env* or *.env.ps1* files. These files are always generated by the deployment script (*azdeploy.sh* or *azdeploy.ps1*) and should not be manually authored. Students load environment variables into their terminal session by running **source .env** (Bash) or **. .\.env.ps1** (PowerShell) after the deployment script creates the file. All Azure CLI commands in exercises should reference these environment variables (e.g., **$RESOURCE_GROUP**, **$NAMESPACE_NAME**) rather than hardcoded values.

## Writing Exercise Instructions

### Inline Code Usage

Do not use inline code formatting (backticks) in exercise instructions except when:

1. **Commands the student must run** - e.g., `az login`, `pip install psycopg`

Avoid using inline code for:
- General technical terms (PostgreSQL, Microsoft Entra, Azure CLI)
- Describing concepts or features
- Menu options or UI elements (use **bold** instead)
- File names (use *italics* instead)
- Referencing commands, environment variables, or syntax in prose or notes (use **bold** instead)

### When to Use Bold vs Inline Code

- Use inline code only when the student must literally type, enter, or copy the value
  - Example: "Open this URL in your browser: `https://portal.azure.com`"
- Use **bold** when referencing commands, variables, or syntax in explanatory text
  - Example: "The **PGPASSWORD** environment variable is automatically used for authentication."
  - Example: "After running the script, use the **source** command to load variables."

### File Names

Use italics for file names in prose - e.g., *azdeploy.sh*, *agent_tools.py*, *.env*

### Command Steps

Steps that direct a student to run a command should:

1. Start with "Run the following command to **<do something>**."
2. Follow with a brief explanation of what the command does

Example:
```
1. Run the following command to load the environment variables into your terminal session. This command exports the variables from the *.env* file so they are available to subsequent commands and scripts.

    ```bash
    source .env
    ```
```

### Section Introductions

Each section (## heading) should begin with an introductory sentence that follows the pattern "In this section you..." followed by a clear explanation of what the student will accomplish and why.

Example:
```
## Create the agent memory schema

In this section you design and create the database schema that stores conversation history and task state. The schema includes three tables: one for conversations (agent sessions), one for messages within those conversations, and one for task checkpoints that enable the agent to resume interrupted work.
```

### Clean Up Resources Section

Always use the following exact verbiage for the clean up resources section at the end of exercises:

```markdown
# Clean up resources

Now that you finished the exercise, you should delete the cloud resources you created to avoid unnecessary resource usage.

1. Run the following command in the VS Code terminal to delete the resource group, and all resources in the group. Replace **\<rg-name>** with the name you choose earlier in the exercise. The command will launch a background task in Azure to delete the resource group.

    ```
    az group delete --name <rg-name> --no-wait --yes
    ```

> **CAUTION:** Deleting a resource group deletes all resources contained within it. If you chose an existing resource group for this exercise, any existing resources outside the scope of this exercise will also be deleted.
```

### Deployment Scripts (azdeploy.sh / azdeploy.ps1)

When updating deployment scripts for new exercises:

1. **Never modify the first 11 lines** - The header section with variable declarations (`rg`, `location`) and comments must remain unchanged.

2. **Preserve existing patterns** - Do not rewrite functions that don't need changes. Only modify:
   - Resource names and variables below line 11
   - Service-specific creation/configuration functions
   - Menu items and descriptions
   - Status check logic for the new services

3. **Follow established conventions**:
   - Use `> /dev/null 2>&1` for output suppression (not `--output none`)
   - Check if resources exist before creating them
   - Use checkmarks (✓) for success and warnings (⚠) for incomplete states
   - Use "Error: ..." prefix for error messages
   - Use `local` for function-scoped variables
   - Generate unique resource names using Azure user object ID hash
   - Include Azure auth check at script startup

4. **Reference scripts** - Use existing scripts in the repository as templates. Good examples:
   - *finished/azure-container-apps/scale-container-aca/python/azdeploy.sh*

5. **When asked to update a copied script**:
   - First review the source script to understand existing patterns
   - Only modify service-specific logic (create, configure, status check functions)
   - Keep the menu loop structure, resource group function, and env file patterns intact
   - Update variable names and menu text to match the new exercise

### Azure CLI Commands

Before answering questions about Azure CLI commands, generating CLI commands, or updating content that includes CLI commands:

1. **Always verify command syntax** - Use MCP tools or official documentation to confirm:
   - Available parameters and their correct names
   - Required vs optional parameters
   - Valid parameter values (case sensitivity matters, e.g., `Enabled` not `enabled`)
   - Whether parameters like `--no-wait` are actually supported for that specific command

2. **Check for deprecated commands** - Azure CLI commands change over time:
   - `ad-admin` commands were replaced by `microsoft-entra-admin`
   - `--active-directory-auth` was replaced by `--microsoft-entra-auth`
   - Always verify the current recommended command

3. **Use available tools** - When in doubt:
   - Run `az <command> --help` in the terminal to see actual available options
   - Fetch the official Microsoft Learn documentation for the command
   - Don't assume a parameter exists just because it seems logical

### Exercise Markdown Structure

Every exercise markdown file must follow this exact structure. Use *finished/app-sec-config/key-vault/python/01-aks-retrieve-secrets.md* as the canonical reference.

1. **YAML frontmatter** — Required at the top of the file:
   ```yaml
   ---
   lab:
       topic: '<topic area>'
       title: '<exercise title>'
       description: '<one-sentence description>'
       level: 300
       duration: <minutes>
   ---
   ```

2. **`#` heading** — A single top-level heading matching the `title` in frontmatter.

3. **Intro paragraphs** — Two paragraphs:
   - First: Explain the technology and why it matters.
   - Second: Start with "In this exercise, you..." and describe what the student will do end-to-end.

4. **Task list** — A bullet list of high-level tasks (download, create resources, add code, run the app).

5. **Time estimate** — "This exercise takes approximately **N** minutes to complete."

6. **Required sections in order**:
   - `## Before you start` — Prerequisites (Azure subscription, VS Code, Python version, Azure CLI).
   - `## Download project starter files and deploy <resource>` — Download zip, open in VS Code, edit script variables, `az login`, register provider, run deployment script with numbered menu walkthrough, load env vars.
   - `## Complete the app` — Intro sentence, then `### Add code to <do something>` subsections. Each subsection must include:
     - "In this section you..." intro sentence.
     - Explanatory paragraph about what the code does (use **bold** for function/method names).
     - Numbered step: "Locate the **# BEGIN ...** comment and add the following code under the comment."
     - Code block with the student code.
     - "Save your changes and take a few minutes to review the code." (or "Take a few minutes to review the code.")
   - `## Configure the Python environment` — cd client, create venv, activate (Bash + PowerShell), pip install.
   - `## Run the app` — Start Flask, open browser, step-by-step UI walkthrough.
   - `## Clean up resources` — Exact verbiage (see "Clean Up Resources Section" above).
   - `## Troubleshooting` — Common issues grouped by bold headings with bullet-point fixes.

### Client App Patterns

All exercises that include a Python client app follow the same project structure. Use *finished/app-sec-config/key-vault/python/client/* as the canonical reference.

**Directory structure:**
```
client/
├── app.py                  # Flask application (pre-written, student does NOT modify)
├── <topic>_functions.py    # Student code module with BEGIN/END markers
├── requirements.txt        # Pinned dependencies
├── static/
│   └── css/
│       └── style.css       # Fluent-inspired CSS (reuse across exercises)
└── templates/
    └── index.html          # Two-panel layout (actions left, results right)
```

**Conventions:**

1. **Student code module** (`<topic>_functions.py`):
   - Name matches the exercise topic (e.g., `keyvault_functions.py`, `telemetry_functions.py`, `service_bus_functions.py`).
   - Contains a helper function (e.g., `get_client()`, `get_tracer()`) that creates the SDK client or tracer.
   - Each student code section is wrapped in `# BEGIN <SECTION NAME>` and `# END <SECTION NAME>` comment markers.
   - Functions between the markers are what the student adds. Helper functions and imports outside the markers are pre-written.

2. **Flask app** (`app.py`):
   - Student does NOT modify this file. It is complete and ready to use.
   - Uses `Flask`, `render_template`, `redirect`, `url_for`, `flash` from Flask.
   - Uses `os.urandom(24)` for `app.secret_key`.
   - Routes call functions from the student code module and pass results to the template.
   - Runs on port 5000 with `debug=False` and `host="0.0.0.0"`.
   - Suppresses werkzeug logging: `logging.getLogger("werkzeug").setLevel(logging.WARNING)`.

3. **HTML template** (`templates/index.html`):
   - Two-panel grid layout: left panel has action buttons (forms with POST), right panel displays results.
   - Uses flash messages for success/error feedback.
   - Includes accessibility: `skip-link`, `aria-labelledby`, `aria-live="polite"`, `sr-only` captions.
   - Results are conditionally rendered with `{% if ... is defined and ... %}` blocks.

4. **CSS** (`static/css/style.css`):
   - Reuse the Fluent-inspired stylesheet from the key-vault reference across all exercises.
   - Only change the `section-*` color accent values (`border-bottom-color`) to match the exercise topic.

5. **Dependencies** (`requirements.txt`):
   - Pin exact versions for all packages.
   - Always include `azure-identity` when the app uses Azure SDK clients.

### Authentication

All exercises must use Microsoft Entra ID authentication via **DefaultAzureCredential**. Never use API keys, access keys, or connection-string-only authentication.

1. **Client code** — Import `DefaultAzureCredential` from `azure.identity` and pass it as the `credential` parameter to SDK clients:
   ```python
   from azure.identity import DefaultAzureCredential
   credential = DefaultAzureCredential()
   ```

2. **Deployment script** — The *azdeploy.sh* / *azdeploy.ps1* script must include a menu option to assign the appropriate RBAC role scoped to the Azure resource. Common role mappings:
   - Key Vault: **Key Vault Secrets Officer**
   - Application Insights: **Monitoring Metrics Publisher**
   - Service Bus: **Azure Service Bus Data Owner**
   - Event Grid: **EventGrid Data Sender**
   - Cosmos DB: use Entra authentication with the appropriate data-plane role
   - App Configuration: **App Configuration Data Reader**

3. **Environment variables** — The *.env* file should contain resource endpoints and connection strings, but authentication is always handled by `DefaultAzureCredential`, not by keys embedded in environment variables. The connection string may include an instrumentation key (e.g., Application Insights), but the `credential` parameter tells the SDK to authenticate via Entra ID instead.

4. **Exercise instructions** — When describing the role assignment step, explain what the role allows (e.g., "publish telemetry using Entra authentication") so the student understands why it's needed.
