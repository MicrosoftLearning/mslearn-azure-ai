In this exercise, you build a vector search solution for a document knowledge base. You enable the pgvector extension, create a schema designed for RAG workloads, load sample data, create vector indexes, and write queries that retrieve relevant documents for semantic search and retrieval-augmented generation.

> [!NOTE]
> This exercise requires an Azure Database for PostgreSQL instance with the pgvector extension available. You can complete the SQL portions using any PostgreSQL client connected to your database.

## Enable the pgvector extension

Before you can store and query vector embeddings, you must enable the pgvector extension in your database.

1. Connect to your Azure Database for PostgreSQL using your preferred client (psql, Azure Data Studio, or pgAdmin).

1. Enable the pgvector extension:

    ```sql
    CREATE EXTENSION IF NOT EXISTS vector;
    ```

1. Verify the extension is installed:

    ```sql
    SELECT * FROM pg_extension WHERE extname = 'vector';
    ```

    You should see a row confirming the vector extension is active.

## Create the database schema

Create a schema that separates source documents from chunks, supporting RAG retrieval patterns with citation tracking.

1. Create the source documents table:

    ```sql
    CREATE TABLE source_documents (
        id SERIAL PRIMARY KEY,
        title TEXT NOT NULL,
        source_url TEXT,
        document_type TEXT,
        ingested_at TIMESTAMPTZ DEFAULT NOW()
    );
    ```

1. Create the document chunks table with a vector column for embeddings:

    ```sql
    CREATE TABLE document_chunks (
        id SERIAL PRIMARY KEY,
        document_id INTEGER REFERENCES source_documents(id) ON DELETE CASCADE,
        chunk_index INTEGER NOT NULL,
        content TEXT NOT NULL,
        embedding vector(384),
        token_count INTEGER,
        section_title TEXT,
        UNIQUE (document_id, chunk_index)
    );
    ```

    This schema uses 384 dimensions, matching common sentence transformer models. Adjust the dimension if you use a different embedding model.

1. Create a B-tree index for efficient document lookups:

    ```sql
    CREATE INDEX document_chunks_document_id_idx ON document_chunks (document_id);
    CREATE INDEX document_chunks_doc_chunk_idx ON document_chunks (document_id, chunk_index);
    ```

## Insert sample data

Load sample documents and chunks with pre-generated embeddings. In a production system, you would generate embeddings using an API like Azure OpenAI.

1. Insert sample source documents:

    ```sql
    INSERT INTO source_documents (title, source_url, document_type) VALUES
        ('Employment Agreement Guidelines', 'https://legal.example.com/employment', 'policy'),
        ('Corporate Merger Procedures', 'https://legal.example.com/mergers', 'procedure'),
        ('Intellectual Property Policy', 'https://legal.example.com/ip-policy', 'policy'),
        ('Data Privacy Compliance Guide', 'https://legal.example.com/privacy', 'compliance');
    ```

1. Insert sample chunks with embeddings. These simplified embeddings demonstrate the conceptâ€”production embeddings would come from an embedding model:

    ```sql
    -- Chunks for Employment Agreement Guidelines (document_id = 1)
    INSERT INTO document_chunks (document_id, chunk_index, content, section_title, token_count, embedding) VALUES
        (1, 0, 'Employment agreements must clearly define the roles and responsibilities of both employer and employee. Key terms include job title, reporting structure, and primary duties.', 'Roles and Responsibilities', 35, '[0.1, 0.2, 0.15, -0.1, 0.05, 0.3, -0.2, 0.1, 0.25, -0.15, 0.2, 0.1, -0.05, 0.15, 0.2, -0.1, 0.1, 0.25, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3, -0.15, 0.1, 0.2, -0.05, 0.15, 0.25, -0.1, 0.1, 0.2, 0.05, -0.2, 0.15, 0.1, -0.1, 0.2, 0.05, 0.3]'),
        (1, 1, 'Compensation terms should specify base salary, bonus structure, equity grants, and payment schedule. All compensation must comply with applicable wage and hour laws.', 'Compensation', 32, '[0.15, 0.25, 0.1, -0.15, 0.1, 0.25, -0.15, 0.15, 0.2, -0.1, 0.25, 0.05, -0.1, 0.2, 0.15, -0.05, 0.15, 0.2, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25, 0.1, 0.25, -0.1, 0.15, 0.15, -0.1, 0.2, 0.2, -0.15, 0.05, 0.25, 0.1, -0.15, 0.2, 0.05, -0.15, 0.25]'),
        (1, 2, 'Termination clauses must specify notice periods, severance terms, and conditions under which immediate termination is permitted. Document grounds for termination with cause.', 'Termination', 30, '[0.2, 0.15, 0.25, -0.05, 0.15, 0.2, -0.1, 0.2, 0.15, -0.2, 0.15, 0.15, -0.15, 0.1, 0.25, -0.15, 0.2, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2, 0.1, -0.15, 0.1, 0.15, -0.2, 0.15, 0.15, 0.15, -0.1, 0.1, 0.15, -0.2, 0.15, 0.15, 0.2, -0.2, 0.2]');

    -- Chunks for Corporate Merger Procedures (document_id = 2)
    INSERT INTO document_chunks (document_id, chunk_index, content, section_title, token_count, embedding) VALUES
        (2, 0, 'Merger due diligence requires comprehensive review of financial statements, contracts, intellectual property, and pending litigation. All material risks must be documented.', 'Due Diligence', 28, '[0.3, 0.1, 0.2, -0.2, 0.2, 0.15, -0.25, 0.05, 0.3, -0.1, 0.1, 0.2, -0.2, 0.25, 0.1, -0.2, 0.05, 0.3, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25, 0.2, 0.1, 0.2, -0.25, 0.25, 0.1, -0.05, 0.1, 0.2, 0.15, -0.3, 0.05, 0.25, -0.2, 0.25, 0.1, -0.25]'),
        (2, 1, 'Shareholder approval processes vary by jurisdiction and company bylaws. Document voting thresholds, proxy procedures, and required disclosures for merger transactions.', 'Shareholder Approval', 27, '[0.25, 0.15, 0.15, -0.15, 0.25, 0.1, -0.2, 0.1, 0.25, -0.15, 0.15, 0.15, -0.15, 0.2, 0.15, -0.15, 0.1, 0.25, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15, 0.2, 0.15, -0.2, 0.15, 0.15, 0.15, -0.2, 0.2, 0.15, -0.1, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.15]);

    -- Chunks for Data Privacy Compliance (document_id = 4)
    INSERT INTO document_chunks (document_id, chunk_index, content, section_title, token_count, embedding) VALUES
        (4, 0, 'Data privacy regulations require explicit consent for collecting personal information. Organizations must document the legal basis for processing and provide clear privacy notices.', 'Consent Requirements', 30, '[-0.1, 0.3, 0.05, -0.25, 0.1, 0.35, -0.15, 0.2, 0.1, -0.3, 0.25, 0.05, -0.2, 0.15, 0.3, -0.1, 0.2, 0.1, 0.25, -0.2, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3, 0.15, 0.2, -0.1, 0.25, 0.1, 0.05, -0.3, 0.05, 0.25, -0.15, 0.3, 0.1, 0.15, -0.25, 0.2, 0.05, -0.3]'),
        (4, 1, 'Data breach notification procedures require prompt reporting to affected individuals and regulatory authorities. Establish clear timelines and communication templates for incident response.', 'Breach Notification', 29, '[-0.15, 0.25, 0.1, -0.2, 0.15, 0.3, -0.1, 0.15, 0.15, -0.25, 0.2, 0.1, -0.15, 0.2, 0.25, -0.15, 0.15, 0.15, 0.2, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25, 0.2, 0.15, -0.15, 0.2, 0.15, 0.1, -0.25, 0.1, 0.2, -0.2, 0.25, 0.15, 0.2, -0.2, 0.15, 0.1, -0.25]);
    ```

1. Verify the data was inserted:

    ```sql
    SELECT
        sd.title,
        COUNT(dc.id) AS chunk_count
    FROM source_documents sd
    LEFT JOIN document_chunks dc ON sd.id = dc.document_id
    GROUP BY sd.id, sd.title
    ORDER BY sd.id;
    ```

## Create a vector index

Create an HNSW index to enable fast similarity search. HNSW provides excellent query performance and works well for most use cases.

1. Create the HNSW index for cosine similarity:

    ```sql
    CREATE INDEX document_chunks_embedding_idx
    ON document_chunks USING hnsw (embedding vector_cosine_ops)
    WITH (m = 16, ef_construction = 64);
    ```

1. Configure the search parameter for better recall:

    ```sql
    SET hnsw.ef_search = 100;
    ```

1. Verify the index was created:

    ```sql
    SELECT
        indexname,
        indexdef
    FROM pg_indexes
    WHERE tablename = 'document_chunks';
    ```

## Execute similarity queries

Run vector similarity queries to find documents relevant to a search query.

1. Define a sample query embedding. In production, you would generate this from the user's search text using an embedding API:

    ```sql
    -- Query embedding representing "employee termination notice requirements"
    WITH query AS (
        SELECT '[0.18, 0.12, 0.22, -0.08, 0.12, 0.18, -0.12, 0.18, 0.14, -0.18, 0.14, 0.12, -0.14, 0.12, 0.22, -0.14, 0.18, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14]'::vector AS embedding
    )
    SELECT
        dc.id,
        dc.content,
        dc.section_title,
        sd.title AS source_document,
        dc.embedding <=> q.embedding AS distance
    FROM document_chunks dc
    JOIN source_documents sd ON dc.document_id = sd.id
    CROSS JOIN query q
    ORDER BY dc.embedding <=> q.embedding
    LIMIT 5;
    ```

    The query returns chunks ordered by similarity to the query embedding, with the most relevant chunks first.

1. Verify the index is being used:

    ```sql
    EXPLAIN ANALYZE
    SELECT dc.id, dc.content
    FROM document_chunks dc
    ORDER BY dc.embedding <=> '[0.18, 0.12, 0.22, -0.08, 0.12, 0.18, -0.12, 0.18, 0.14, -0.18, 0.14, 0.12, -0.14, 0.12, 0.22, -0.14, 0.18, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14]'::vector
    LIMIT 5;
    ```

    Look for "Index Scan using document_chunks_embedding_idx" in the output, confirming the HNSW index is being used.

## Implement filtered search

Combine vector similarity with metadata filters to search within specific document types.

1. Search only within policy documents:

    ```sql
    WITH query AS (
        SELECT '[0.18, 0.12, 0.22, -0.08, 0.12, 0.18, -0.12, 0.18, 0.14, -0.18, 0.14, 0.12, -0.14, 0.12, 0.22, -0.14, 0.18, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14]'::vector AS embedding
    )
    SELECT
        dc.content,
        dc.section_title,
        sd.title AS source_document,
        sd.document_type,
        dc.embedding <=> q.embedding AS distance
    FROM document_chunks dc
    JOIN source_documents sd ON dc.document_id = sd.id
    CROSS JOIN query q
    WHERE sd.document_type = 'policy'
    ORDER BY dc.embedding <=> q.embedding
    LIMIT 3;
    ```

1. Add a distance threshold to filter out irrelevant results:

    ```sql
    WITH query AS (
        SELECT '[0.18, 0.12, 0.22, -0.08, 0.12, 0.18, -0.12, 0.18, 0.14, -0.18, 0.14, 0.12, -0.14, 0.12, 0.22, -0.14, 0.18, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14]'::vector AS embedding
    )
    SELECT
        dc.content,
        sd.title AS source_document,
        dc.embedding <=> q.embedding AS distance
    FROM document_chunks dc
    JOIN source_documents sd ON dc.document_id = sd.id
    CROSS JOIN query q
    WHERE dc.embedding <=> q.embedding < 0.5
    ORDER BY dc.embedding <=> q.embedding
    LIMIT 5;
    ```

## Build a RAG-style retrieval query

Create a query that returns chunks with full citation metadata, suitable for passing to an LLM as context.

1. Build the complete RAG retrieval query:

    ```sql
    WITH query AS (
        SELECT '[0.18, 0.12, 0.22, -0.08, 0.12, 0.18, -0.12, 0.18, 0.14, -0.18, 0.14, 0.12, -0.14, 0.12, 0.22, -0.14, 0.18, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14]'::vector AS embedding
    )
    SELECT
        dc.content,
        dc.section_title,
        dc.chunk_index,
        dc.token_count,
        sd.title AS document_title,
        sd.source_url,
        sd.document_type,
        ROUND((dc.embedding <=> q.embedding)::numeric, 4) AS relevance_score
    FROM document_chunks dc
    JOIN source_documents sd ON dc.document_id = sd.id
    CROSS JOIN query q
    WHERE dc.embedding <=> q.embedding < 0.6
    ORDER BY dc.embedding <=> q.embedding
    LIMIT 3;
    ```

    This query returns everything needed to construct LLM context with citations:
    - **content:** The text to include in the LLM prompt
    - **section_title, chunk_index:** Context about where in the document this content appears
    - **document_title, source_url:** Citation information
    - **relevance_score:** How well the chunk matches the query

1. Calculate cumulative token count to stay within LLM context limits:

    ```sql
    WITH query AS (
        SELECT '[0.18, 0.12, 0.22, -0.08, 0.12, 0.18, -0.12, 0.18, 0.14, -0.18, 0.14, 0.12, -0.14, 0.12, 0.22, -0.14, 0.18, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14, 0.12, 0.14, -0.18, 0.14, 0.14, 0.12, -0.12, 0.12, 0.12, -0.18, 0.14, 0.12, 0.18, -0.18, 0.18, 0.12, -0.14]'::vector AS embedding
    ),
    ranked_chunks AS (
        SELECT
            dc.content,
            sd.title AS document_title,
            dc.token_count,
            dc.embedding <=> q.embedding AS distance,
            SUM(dc.token_count) OVER (ORDER BY dc.embedding <=> q.embedding) AS cumulative_tokens
        FROM document_chunks dc
        JOIN source_documents sd ON dc.document_id = sd.id
        CROSS JOIN query q
        ORDER BY dc.embedding <=> q.embedding
    )
    SELECT content, document_title, token_count, cumulative_tokens
    FROM ranked_chunks
    WHERE cumulative_tokens <= 100;
    ```

    This query retrieves the most relevant chunks that fit within a 100-token context limit. In production, you would set this limit based on your LLM's context window minus space needed for the prompt and response.

## Clean up resources

If you created this schema for testing, remove the tables:

```sql
DROP TABLE IF EXISTS document_chunks;
DROP TABLE IF EXISTS source_documents;
```

You completed the exercise. You enabled pgvector, created a RAG-optimized schema, inserted sample data with embeddings, created an HNSW index for fast similarity search, and wrote queries that combine vector similarity with metadata filtering and citation tracking.
