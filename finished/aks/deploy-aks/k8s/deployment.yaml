apiVersion: apps/v1
kind: Deployment  # Deployment: manages replicated pod instances and rolling updates
metadata:
  name: aks-api  # Unique name for the deployment
  labels:  # Labels for selecting this deployment resource
    app: aks-api
    version: v1
spec:  # Desired state specification for the deployment
  replicas: 1
  selector:  # Selects which pods this deployment manages based on labels
    matchLabels:
      app: aks-api # Will match pods with label app: aks-api
      version: v1
  template:  # Pod template: defines the blueprint for creating pods
    metadata:
      labels:  # Labels applied to each pod created from this template
        app: aks-api
        version: v1
    spec:  # Defines what the pod should contain

      # BEGIN: Container specification
      containers:  # List of containers to run in the pod
      - name: api
        image: ACR_ENDPOINT/aks-api:latest  # Container image from ACR
        imagePullPolicy: Always  # Always pull the latest image from registry
        ports:  # Ports exposed by the container
        - name: http
          containerPort: 8000
          protocol: TCP
      # END: Container specification

        env:  # Environment variables passed to the container
        - name: OPENAI_API_ENDPOINT
          valueFrom:  # Retrieve value from secret
            secretKeyRef:
              name: foundry-credentials
              key: endpoint
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: foundry-credentials
              key: api-key
        - name: OPENAI_DEPLOYMENT_NAME # Value not pulled from secrets
          value: "gpt-4o-mini"
        - name: OPENAI_API_VERSION
          value: "2024-10-21"

        # BEGIN: Liveness Probe Configuration
        livenessProbe:  # Detects if container is alive or needs restart
          httpGet:
            path: /healthz  # Health check endpoint path
            port: http
          initialDelaySeconds: 10  # Seconds to wait before first check
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3  # Consecutive failures before restarting container
        # END: Liveness Probe Configuration

        # BEGIN: Readiness Probe Configuration
        readinessProbe:  # Detects if container is ready to receive traffic
          httpGet:
            path: /readyz  # Readiness check endpoint path
            port: http
          initialDelaySeconds: 15  # Seconds to wait before first check
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3  # Consecutive failures before removing from service
        # END: Readiness Probe Configuration

        # BEGIN: Resource Limits Configuration
        resources:  # CPU and memory resource specifications
          requests:  # Minimum resources guaranteed to the container
            memory: "256Mi"
            cpu: "250m"
          limits:  # Maximum resources the container can use
            memory: "512Mi"
            cpu: "500m"
        # END: Resource Limits Configuration
