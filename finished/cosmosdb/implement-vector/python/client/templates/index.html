<!DOCTYPE html>
<html lang="en">
<head>
    <title>Vector Search - Cosmos DB</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <main id="main-content" class="container">
        <h1>Vector Search - Cosmos DB for NoSQL</h1>
        <div class="left-panel">
            <!-- Load Sample Data -->
            <section class="section section-load">
                <h2>Load Sample Data</h2>
                <p>Upload sample support tickets with pre-computed 256-dimensional embeddings to the Cosmos DB container.</p>
                <form action="/load-data" method="post">
                    <button type="submit" class="btn-success">Load Vector Data</button>
                </form>
            </section>

            <!-- Vector Similarity Search -->
            <section class="section section-search">
                <h2>Vector Similarity Search</h2>
                <p>Find tickets most similar to a query using VectorDistance.</p>
                <form action="/vector-search" method="post">
                    <label for="query_id">Select Query</label>
                    <select id="query_id" name="query_id" required>
                        <option value="">-- Select a query --</option>
                        {% for query in queries %}
                            <option value="{{ query.id }}">{{ query.description }}</option>
                        {% endfor %}
                    </select>
                    <label for="top_n">Number of Results</label>
                    <select id="top_n" name="top_n">
                        <option value="3">Top 3</option>
                        <option value="5" selected>Top 5</option>
                        <option value="10">Top 10</option>
                    </select>
                    <button type="submit" class="btn-primary">Search</button>
                </form>
            </section>

            <!-- Filtered Vector Search -->
            <section class="section section-get">
                <h2>Filtered Vector Search</h2>
                <p>Combine metadata filtering with vector similarity ranking.</p>
                <form action="/filtered-vector-search" method="post">
                    <label for="filtered_query_id">Select Query</label>
                    <select id="filtered_query_id" name="filtered_query_id" required>
                        <option value="">-- Select a query --</option>
                        {% for query in queries %}
                            <option value="{{ query.id }}">{{ query.description }}</option>
                        {% endfor %}
                    </select>
                    <label for="filter_category">Filter by Category</label>
                    <select id="filter_category" name="filter_category">
                        <option value="">-- Any category --</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                    <label for="filtered_top_n">Number of Results</label>
                    <select id="filtered_top_n" name="filtered_top_n">
                        <option value="3">Top 3</option>
                        <option value="5" selected>Top 5</option>
                        <option value="10">Top 10</option>
                    </select>
                    <button type="submit" class="btn-primary">Search with Filter</button>
                </form>
            </section>
        </div>

        <div class="right-panel">
            <!-- Results Section -->
            <section class="section section-results" aria-live="polite" aria-atomic="true">
                <h2>Results</h2>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% for category, message in messages %}
                        <div class="flash {{ category }}" role="alert">{{ message }}</div>
                    {% endfor %}
                {% endwith %}

                <!-- Vector Search Results -->
                {% if vector_result is defined %}
                    <h3>Vector Search Results</h3>
                    <div class="query-info">
                        Query: "{{ vector_query }}" | Top {{ vector_top_n }} results
                    </div>
                    {% if vector_result %}
                        <div class="results-container">
                            {% for item in vector_result %}
                                <div class="chunk-card">
                                    <div class="chunk-id">
                                        {{ item.document_id }} / {{ item.chunk_id }}
                                        <span class="similarity-score">Score: {{ "%.4f"|format(item.similarity_score) }}</span>
                                    </div>
                                    <div class="chunk-content">{{ item.content }}</div>
                                    <div class="chunk-meta">
                                        {% if item.metadata.category %}
                                            <span class="tag tag-category">{{ item.metadata.category }}</span>
                                        {% endif %}
                                        {% for tag in item.metadata.tags or [] %}
                                            <span class="tag">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">No similar tickets found.</div>
                    {% endif %}

                <!-- Filtered Vector Search Results -->
                {% elif filtered_result is defined %}
                    <h3>Filtered Vector Search Results</h3>
                    <div class="query-info">
                        Query: "{{ filtered_query }}" |
                        {% if filtered_category %}Category: "{{ filtered_category }}" | {% endif %}
                        Top {{ filtered_top_n }} results
                    </div>
                    {% if filtered_result %}
                        <div class="results-container">
                            {% for item in filtered_result %}
                                <div class="chunk-card">
                                    <div class="chunk-id">
                                        {{ item.document_id }} / {{ item.chunk_id }}
                                        <span class="similarity-score">Score: {{ "%.4f"|format(item.similarity_score) }}</span>
                                    </div>
                                    <div class="chunk-content">{{ item.content }}</div>
                                    <div class="chunk-meta">
                                        {% if item.metadata.category %}
                                            <span class="tag tag-category">{{ item.metadata.category }}</span>
                                        {% endif %}
                                        {% for tag in item.metadata.tags or [] %}
                                            <span class="tag">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">No tickets found matching the filter.</div>
                    {% endif %}

                {% else %}
                    <div class="empty-state">
                        Results will appear here after you perform an action.
                    </div>
                {% endif %}
            </section>
        </div>
    </main>
</body>
</html>
