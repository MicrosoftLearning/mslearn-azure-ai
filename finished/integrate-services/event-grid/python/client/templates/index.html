<!DOCTYPE html>
<html lang="en">
<head>
    <title>Content Moderation Events - Azure Event Grid</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <main id="main-content" class="container">
        <h1>Content Moderation Events - Azure Event Grid</h1>
        <div class="left-panel">
            <!-- Event Publishing -->
            <section class="section section-publish" aria-labelledby="publish-heading">
                <h2 id="publish-heading">Event Publishing</h2>
                <p>Publish AI content moderation events to the Event Grid topic. Events include flagged content, approved content, and escalated reviews.</p>
                <form action="/publish-events" method="post">
                    <button type="submit" class="btn-success">Publish Moderation Events</button>
                </form>
            </section>

            <!-- Event Delivery -->
            <section class="section section-delivery" aria-labelledby="delivery-heading">
                <h2 id="delivery-heading">Event Delivery</h2>
                <p>Check how Event Grid filtered and routed events to different Service Bus queues, or inspect the CloudEvent structure of a delivered event.</p>
                <div class="button-group">
                    <form action="/check-delivery" method="post">
                        <button type="submit" class="btn-primary">Check Filtered Delivery</button>
                    </form>
                    <form action="/inspect-event" method="post">
                        <button type="submit" class="btn-warning">Inspect Event Details</button>
                    </form>
                </div>
            </section>
        </div>

        <div class="right-panel">
            <!-- Results Section -->
            <section class="section section-results" aria-live="polite" aria-atomic="true" aria-labelledby="results-heading">
                <h2 id="results-heading">Results</h2>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% for category, message in messages %}
                        <div class="flash {{ category }}" role="alert">{{ message }}</div>
                    {% endfor %}
                {% endwith %}

                <!-- Publish Results -->
                {% if publish_results is defined and publish_results %}
                    <h3>Events Published to Topic</h3>
                    <div class="results-container" tabindex="0" role="region" aria-label="Events published to topic">
                        <table class="results-table">
                            <caption class="sr-only">Events published to topic</caption>
                            <thead>
                                <tr>
                                    <th scope="col">Content ID</th>
                                    <th scope="col">Event Type</th>
                                    <th scope="col">Category</th>
                                    <th scope="col">Confidence</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in publish_results %}
                                    <tr>
                                        <td>{{ event.content_id }}</td>
                                        <td><span class="tag tag-type-{{ event.event_type | lower }}">{{ event.event_type }}</span></td>
                                        <td>{{ event.category }}</td>
                                        <td>{{ "%.0f%%" | format(event.confidence * 100) }}</td>
                                        <td><span class="tag tag-success">{{ event.status }}</span></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                <!-- Delivery Results -->
                {% elif delivery_results is defined %}
                    <h3>Flagged Content Queue <span class="subtitle">(event type filter)</span></h3>
                    <div class="query-info">Received {{ delivery_results.flagged | length }} event(s)</div>
                    <div class="results-container" tabindex="0" role="region" aria-label="Flagged content queue results">
                        {% if delivery_results.flagged %}
                            <table class="results-table">
                                <caption class="sr-only">Flagged content queue — filtered events</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">Content ID</th>
                                        <th scope="col">Category</th>
                                        <th scope="col">Severity</th>
                                        <th scope="col">Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for event in delivery_results.flagged %}
                                        <tr>
                                            <td>{{ event.content_id }}</td>
                                            <td><span class="tag tag-type-contentflagged">{{ event.category }}</span></td>
                                            <td><span class="tag tag-severity-{{ event.severity }}">{{ event.severity }}</span></td>
                                            <td>{{ "%.0f%%" | format(event.confidence * 100) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div class="empty-state">No flagged events received.</div>
                        {% endif %}
                    </div>

                    <h3>Approved Content Queue <span class="subtitle">(event type filter)</span></h3>
                    <div class="query-info">Received {{ delivery_results.approved | length }} event(s)</div>
                    <div class="results-container" tabindex="0" role="region" aria-label="Approved content queue results">
                        {% if delivery_results.approved %}
                            <table class="results-table">
                                <caption class="sr-only">Approved content queue — filtered events</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">Content ID</th>
                                        <th scope="col">Category</th>
                                        <th scope="col">Severity</th>
                                        <th scope="col">Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for event in delivery_results.approved %}
                                        <tr>
                                            <td>{{ event.content_id }}</td>
                                            <td><span class="tag tag-type-contentapproved">{{ event.category }}</span></td>
                                            <td><span class="tag tag-severity-{{ event.severity }}">{{ event.severity }}</span></td>
                                            <td>{{ "%.0f%%" | format(event.confidence * 100) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div class="empty-state">No approved events received.</div>
                        {% endif %}
                    </div>

                    <h3>All Events Queue <span class="subtitle">(no filter — audit log)</span></h3>
                    <div class="query-info">Received {{ delivery_results.all_events | length }} event(s)</div>
                    <div class="results-container" tabindex="0" role="region" aria-label="All events queue results">
                        {% if delivery_results.all_events %}
                            <table class="results-table">
                                <caption class="sr-only">All events queue — unfiltered audit log</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">Content ID</th>
                                        <th scope="col">Model</th>
                                        <th scope="col">Category</th>
                                        <th scope="col">Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for event in delivery_results.all_events %}
                                        <tr>
                                            <td>{{ event.content_id }}</td>
                                            <td>{{ event.event_type }}</td>
                                            <td>{{ event.category }}</td>
                                            <td>{{ "%.0f%%" | format(event.confidence * 100) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div class="empty-state">No events received.</div>
                        {% endif %}
                    </div>

                <!-- Inspect Result -->
                {% elif inspect_result is defined and inspect_result %}
                    <h3>CloudEvent Structure</h3>
                    <div class="results-container" tabindex="0" role="region" aria-label="CloudEvent details">
                        <div class="message-card card-inspect">
                            <div class="message-header">
                                <span class="message-id">CloudEvent Attributes</span>
                            </div>
                            <div class="message-detail"><strong>specversion:</strong> {{ inspect_result.specversion }}</div>
                            <div class="message-detail"><strong>type:</strong> {{ inspect_result.type }}</div>
                            <div class="message-detail"><strong>source:</strong> {{ inspect_result.source }}</div>
                            <div class="message-detail"><strong>subject:</strong> {{ inspect_result.subject }}</div>
                            <div class="message-detail"><strong>id:</strong> {{ inspect_result.id }}</div>
                            <div class="message-detail"><strong>time:</strong> {{ inspect_result.time }}</div>
                        </div>
                        <div class="message-card card-inspect">
                            <div class="message-header">
                                <span class="message-id">Event Data</span>
                            </div>
                            {% for key, value in inspect_result.data.items() %}
                                <div class="message-detail"><strong>{{ key }}:</strong> {{ value }}</div>
                            {% endfor %}
                        </div>
                    </div>

                {% elif inspect_result is defined and not inspect_result %}
                    <div class="empty-state">No events available to inspect. Publish events first.</div>

                {% else %}
                    <div class="empty-state">
                        Results will appear here after you perform an action.
                    </div>
                {% endif %}
            </section>
        </div>
    </main>
</body>
</html>
